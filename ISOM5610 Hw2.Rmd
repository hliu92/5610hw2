---
title: "ISOM5610 HW2"
author: "Team 1"
date: "22 November 2018"
output: pdf_document
---

```{r}
setwd("~/MSBA/ISOM5610/HW2")
library(readxl)
bluestem <- as.data.frame(read_excel("bluestem.xls", sheet=1))
bluestem[,2:9] <- lapply(bluestem[,2:9], factor)
colnames(bluestem)[1] <- "Sales"
colnames(bluestem)[10] <- "Index"
summary(bluestem)
```



```{r}
#Adding the time index predictor

bluestem$Weekday <- factor(names(bluestem[3:9])[max.col(bluestem[3:9])], levels = c("Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"))
bluestem$timeindex <- c(1:249)

## standardize index

index_table <- unique(bluestem[names(bluestem) %in% c("Weekday", "Index")])
bluestem$Index <- bluestem$Index*7/sum(index_table[,1])
index_table <- unique(bluestem[names(bluestem) %in% c("Weekday", "Index")])
bluestem$desSales <- bluestem$Sales/bluestem$Index

## Add lag predictor for promotion

library(Hmisc)
bluestem$prolag1 <- Lag(bluestem$Promotion,1)
bluestem$prolag2 <- Lag(bluestem$Promotion,2)
```


# Data Exploration

```{r}
library(ggplot2)
library(RColorBrewer)
#See if there is linear trend along the time line

fit0.1 <- lm(Sales ~ timeindex,data=bluestem)
summary(fit0.1)
plot(bluestem$timeindex,bluestem$Sales)
abline(fit0.1,col=2)

fit0.2 <- lm(desSales ~ timeindex,data=bluestem)
summary(fit0.2)
plot(bluestem$timeindex,bluestem$desSales)
abline(fit0.2,col=2)

ggplot(index_table, aes(x = Weekday, y = Index, fill=Weekday)) + 
    geom_bar(stat = "identity") + 
    geom_text(aes(label = sprintf("%0.2f", round(Index, digits = 2))), vjust=-0.6) + 
    scale_fill_manual(values=brewer.pal(7, "Blues")[1:7]) +
    labs(y="Nightly Index")

#Sales on different Weekdays
ggplot(bluestem, aes(x = Weekday, y = Sales, fill=Weekday)) + 
    geom_boxplot() + 
    geom_point(data=subset(bluestem, Promotion==1), mapping=aes(color=Promotion), size=3) + 
    scale_fill_manual(values=brewer.pal(7, "Blues")[1:7]) + 
    scale_color_manual(labels = "With Promotion", values="red")

#Sales with or without promotions
ggplot(bluestem, aes(x = Promotion, y = Sales, fill= Promotion)) +
    geom_boxplot()+
    scale_fill_manual(values=c(brewer.pal(7, "Blues")[4],brewer.pal(7, "Reds")[4]))

#De-seasonalized Sales with or without promotions
ggplot(bluestem, aes(x = Promotion, y = desSales, fill= Promotion)) + 
    geom_boxplot() + 
    scale_fill_manual(values=c(brewer.pal(7, "Blues")[4],brewer.pal(7, "Reds")[4])) +
    labs(y="Sales/Nightly Index")
```

```{r}
library(car)
# This function is a combination of Diagnostic plots, BP test, multicollinearity check for independent variables, and Cochrane-Orcutt test
check_assumption <- function(testfit){
    #Diagnostic plots
    stdres=rstandard(testfit)
    par(mfrow=c(2,2))
    qqnorm(stdres,main='Normal Probability Plot',xlab='Normal Quantiles',ylab='Standardized Residual Quantiles')
    abline(0,1)
    plot(testfit$fitted.values,stdres,main='Versus Fits',xlab='Fitted Value',ylab='Standardized Residual')
    abline(0,0,lty=3)
    hist(stdres,main='Histogram',xlab='Standardized Residual')
    plot(as.ts(stdres),type="o",main='Versus Order',xlab='TimeIndex',ylab='Standardized Residual')
    abline(0,0,lty=3)
    #BP test
    cat("====BP test====\n")
    print(ncvTest(testfit))
    #Checking multicollinearity for independent variables
    cat("\n====Checking multicollinearity for independent variables====\nVIF:\n")
    tryCatch({
         print(vif(testfit))
         },
         warning = function(msg) {
              message("Original warning message:")
              message(paste0(msg,"\n"))
              return(NULL)
         },
         error = function(msg) {
              message("Original error message:")
              message(paste0(msg,"\n"))
              return(NA)
         }
) 
    
    #Cochrane-Orcutt test
    cat("\n====Cochrane-Orcutt test====")
    summary(lm(testfit$residuals~Lag(testfit$residuals, 1)))
}
```


## Additive Model
A regression model using dummy variables to account for the fixed Weekday??s effect.

```{r}
bluestem_1 <- bluestem[,c(1:8)]
add.fit.1 <- lm(Sales ~ ., data = bluestem_1)
summary(add.fit.1)
add.fit.1$coefficients[2]
# Checking model assumptions
check_assumption(add.fit.1)
```

**After the time index is added, Answer = 593.5**

BP Test and CO Test don't pass!!!

```{r}
bluestem_1 <- bluestem[,c(1:8,14)]
add.fit.2 <- lm(Sales ~ ., data = bluestem_1)
summary(add.fit.2)
bluestem_1 <- bluestem[,c(1:8,14,15)]
add.fit.3 <- lm(Sales ~ ., data = bluestem_1)
summary(add.fit.3)
```

fit.2 is better than fit.3 and fit.1


```{r}
# Checking model assumptions

check_assumption(add.fit.2)
```



## Multiplicative Model
The nightly index expresses each Weekday??s effect on the popularity. 

#### 1. Use De-seasonalized Sales.

```{r}
mtp.fit.1 <- lm(desSales ~ Promotion, data = bluestem)
summary(mtp.fit.1)

# The coefficient of Promotion stands for the boost in revenues without Weekday effect. Such boost would be amplified by the Nightly Index for Saturday.
mtp.fit.1$coefficients[2] * index_table$Index[which(index_table$Weekday=="Saturday")]
```

```{r}
# Checking model assumptions
check_assumption(mtp.fit.1)
```

Promotion effect: 801.43

BP test and CO test don't pass


```{r}
mtp.fit.2 <- lm(desSales ~ Promotion + prolag1, data = bluestem)
summary(mtp.fit.2)

mtp.fit.3 <- lm(desSales ~ Promotion + prolag1 + prolag2, data = bluestem)
summary(mtp.fit.3)
```

Both lags are useless.

```{r}
## Conduct CO procedure for fit.1

co.test <- lm(formula = mtp.fit.1$residuals ~ Lag(mtp.fit.1$residuals, 1))
rho <- co.test$coefficients[2]
bluestem.CO.1 <- as.data.frame(lapply(bluestem[,c(13,2)], as.numeric))
bluestem.CO.1 <- bluestem.CO.1[-1,]-bluestem.CO.1[-249,]*rho
co.fit.1 <- lm(desSales ~ Promotion, data = bluestem.CO.1)
summary(co.fit.1)
check_assumption(co.fit.1)
```


#### 2. Try log(De-seasonalized Sales)  Answer, need to multiply weekindex?

```{r}
bluestem$log_desSales <- log(bluestem$desSales)
mtp.fit.4 <- lm(log_desSales ~ Promotion, data = bluestem)
summary(mtp.fit.4)
check_assumption(mtp.fit.4)

mtp.fit.5 <- lm(log_desSales ~ Promotion+prolag1, data = bluestem)
summary(mtp.fit.5)
mtp.fit.6 <- lm(log_desSales ~ Promotion+prolag1+prolag2, data = bluestem)
summary(mtp.fit.6)
```

## Comparison

```{r}
## 3 models are selected in first round selection  add.fit.2 mtp.fit.2 and mtp.fit.6
## L1 L2 percentage---- these three criteria are used to evaluate them


Error <- matrix(0,nrow=3,ncol=3)
colnames(Error) <- c("Mean Squared Error","Absolute Error","Absolute Error Percentage")
rownames(Error) <- c("add.fit.2","mtp.fit.1","mtp.fit.4")

## add.fit.2
bluestem$prolag1[1]<-0
add.pd.2 <- predict(add.fit.2,bluestem)
dif <- bluestem$Sales-add.pd.2
Error[1,1] <- crossprod(dif,dif)/249
Error[1,2] <- sum(abs(dif))/249
Error[1,3] <- sum(abs(dif/bluestem$Sales))/249

## mtp.fit.2
mtp.pd.1 <- predict(mtp.fit.1,bluestem)*bluestem$Index
dif <- bluestem$Sales-mtp.pd.1
Error[2,1] <- crossprod(dif,dif)/249
Error[2,2] <- sum(abs(dif))/249
Error[2,3] <- sum(abs(dif/bluestem$Sales))/249

## mtp.fit.6
mtp.pd.4 <- exp(predict(mtp.fit.4,bluestem))*bluestem$Index
dif <- bluestem$Sales-mtp.pd.4
Error[3,1] <- crossprod(dif,dif)/249
Error[3,2] <- sum(abs(dif))/249
Error[3,3] <- sum(abs(dif/bluestem$Sales))/249


knitr::kable(Error,format = "markdown")
```



**Model assumptions:**  
The additive model is much better in terms of R-square and residual plots. The multiplicative model using log(De-seasonalized Sales) is better than the one directly using De-seasonalized Sales.  
**Business perspective:**   
The multiplicative model is better than the additive model. The additive model assumes that promotions have same boost effect on all weekdays, which is not the case. Promotional events should have better results with larger customer traffic. This is better addressed by the multiplicative model.





## Index

```{r}

## aditive with timeindex

bluestem_1_t <- bluestem[,c(1:8,12)]
add.fit.1_t <- lm(Sales ~ ., data = bluestem_1_t)
summary(add.fit.1_t)


## add lag
bluestem_1_t <- bluestem[,c(1:8,12,14)]
add.fit.2_t <- lm(Sales ~ ., data = bluestem_1_t)
summary(add.fit.2_t)
bluestem_1_t <- bluestem[,c(1:8,12,14,15)]
add.fit.3_t <- lm(Sales ~ ., data = bluestem_1_t)
summary(add.fit.3_t)


## multuple with timeindex

mtp.fit.1_t <- lm(desSales ~ Promotion + timeindex, data = bluestem)
summary(mtp.fit.1_t)


## add lag

mtp.fit.2 <- lm(desSales ~ Promotion + timeindex + prolag1, data = bluestem)
summary(mtp.fit.2)
mtp.fit.3 <- lm(desSales ~ Promotion + timeindex + prolag1 + prolag2, data = bluestem)
summary(mtp.fit.3)


## try log(desSales)

mtp.fit.4 <- lm(log_desSales ~ Promotion+timeindex, data = bluestem)
summary(mtp.fit.4)


mtp.fit.5 <- lm(log_desSales ~ Promotion+timeindex+prolag1, data = bluestem)
summary(mtp.fit.5)


mtp.fit.6 <- lm(log_desSales ~ Promotion+timeindex+prolag1+prolag2, data = bluestem)
summary(mtp.fit.6)



```
